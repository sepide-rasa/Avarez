@using Kendo.Mvc.UI;
<div class="modal" id="Facture">
    <script src="@Url.Content("~/Content/Base.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/web/kendo.common.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/web/kendo.default.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/web/kendo.rtl.min.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/console.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.web.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/prettify.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.aspnetmvc.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.splitter.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/cultures/kendo.fa-IR.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/accounting.js")" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            function sfade() {
                $('.fade').fadeTo(500, 0).fadeTo(500, 1);
                $('.fade1').fadeTo(1000, 0).fadeTo(1000, 1);
            }
            setInterval(
                function () {
                    sfade();
                }
            , 0)
        });
    </script>
    @{
        Avarez.Models.cartaxEntities car = new Avarez.Models.cartaxEntities();
        var picmnu = car.sp_SelectNameBankAndMunForBankInformation(Convert.ToInt32(Session["CountryCode"]), Convert.ToInt32(Session["CountryType"])).ToList();
    }
    <div>
        <img src="@Url.Content("~/Content/images/GeustNAV2.png")" />
        <br />
        <div>
            <div>
                <table>
                    <tr>
                        <td align="left">
                            نام و خانوادگی مالک:
                        </td>
                        <td>
                            @Html.TextBox("txtMalek", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            کد ملی:
                        </td>
                        <td>
                            @Html.TextBox("txtCodeMeli", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            نوع ساخت:
                        </td>
                        <td>
                            @Html.TextBox("txtCarMake", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            نوع کاربری:
                        </td>
                        <td>
                            @Html.TextBox("txtCarAccountTypes", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            نوع کابین:
                        </td>
                        <td>
                            @Html.TextBox("txtCarCabin", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            سیستم خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtSystem", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            تیپ خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtModel", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            کلاس خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtClass", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            شماره موتور:
                        </td>
                        <td>
                            @Html.TextBox("txtMotor", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            شماره شاسی:
                        </td>
                        <td>
                            @Html.TextBox("txtShasi", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            رنگ خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtColor", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            سال تولید:
                        </td>
                        <td>
                            @Html.TextBox("txtYear", null, new { @dir = "ltr", @style = "width: 30px;", @id = "txtYear", @maxlength = "4", @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            VIN:
                        </td>
                        <td dir='rtl'>
                            @Html.TextBox("VIN", null, new { @dir = "ltr", @style = "width:150px;background-color:rgb(255, 202, 153);", @id = "VIN", @readonly = "true", enable = "false" })
                        </td>
                        <td align="left">
                            شماره پلاک:
                        </td>
                        <td>
                            @Html.TextBox("fldPlaqueNum", null, new { @dir = "rtl", @style = "width: 150px;background-color:rgb(255, 202, 153);", @id = "fldPlaqueNum", @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            تاریخ پلاک گذاری:
                        </td>
                        <td>
                            @Html.TextBox("txtDateP", null, new { @dir = "ltr", @style = "width: 70px;", @readonly = "true" })
                        </td>
                        <td align="left">
                            تاریخ اولین بیمه:
                        </td>
                        <td colspan="3">
                            @Html.TextBox("txtDate", null, new { @dir = "ltr", @style = "width: 70px;", @readonly = "true" })
                        </td>
                    </tr>
                    
                    @*<tr>
        <td></td>
        <td>
            <button id="Tree" style="font-size: 9px;" title="مشاهده بایگانی دیجیتال">
                مشاهده بایگانی دیجیتال
            </button>
        </td>
        <td colspan="2">
            <button id="Baygani" style="font-size: 9px;" title="ثبت بایگانی دیجیتال">
                ثبت بایگانی دیجیتال
            </button>
        </td>
    </tr>*@
                    <tr>
                        <td></td>
                        <td>
                            <button id="Bargsabz" style="font-size: 9px;" title="تصویر برگ سبز">
                                تصویر برگ سبز
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="Cart" style="font-size: 9px;" title="تصویر کارت">
                                تصویر کارت خودرو
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="CartBack" style="font-size: 9px;" title="صفحه2 کارت">
                                تصویر صفحه2 کارت خودرو
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="Sanad" style="font-size: 9px;" title="تصویر سند کارخانه">
                                تصویر سند کارخانه
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="EditFish" style="font-size: 9px;" title="ویرایش خودرو">
                                ویرایش مشخصات خودرو
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="ChMalek" style="font-size: 9px;" title="تعویض مالک">
                                تعویض مالک
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="btnEditSavabegh" style="font-size: 9px;" title="ویرایش سوابق">
                                ویرایش سوابق
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="EditPics" style="font-size: 9px;">
                                ویرایش تصاویر
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="btnAgainCalc" style="font-size: 9px;">
                                محاسبه مجدد
                            </button>
                        </td>
                        <td colspan="2">
                            
                        </td>
                    </tr>
                </table>
            </div>
            <div>
                <center>
                    <p>
                        مبلغ عوارض: <span id="lblMablagh"></span>
                        @*<br />
    شناسه قبض: <span id="lblshGhabz"></span>شناسه پرداخت: <span id="lblshPardakht"></span>*@
                        <br />
                        @*<div class="fade1" style="color: red;">در صورتی که قصد دارید از طریق شناسه قبض و شناسه پرداخت نسبت به پرداخت بدهی اقدام کنید
    <br/>
     حتما فیش تهیه کرده و پس از پرداخت فیش مربوطه را ثبت کنید.</div>
    <div class="fade" style="color: red;" id="lblMsg"></div>*@
                    </p>
                    <table style="width: 150px;">
                        <tr align="center">
                            @for (var i = 0; i < picmnu.Count; i++)
                            {
                                
                                <td>
                                    <img src="@Url.Content("~/Bank/image/"+picmnu[i].BankId)" title='@picmnu[i].fldBankName' width="40px" />
                                </td>
                            }	
                            @*<td>
                                <img src="@Url.Content("~/Content/images/CityBank.jpg")" title="بانک شهر" width="40px"/>
                            </td>
                            <td>
                                <img src="@Url.Content("~/Content/images/MelatBank.jpg")" title="بانک ملت" width="40px"/>
                            </td>
                            <td>
                                <img src="@Url.Content("~/Content/images/MeliBank.jpg")" title="بانک ملی" width="40px"/>
                            </td>
                            <td>
                                <img src="@Url.Content("~/Content/images/TejaratBank.jpg")" title="بانک تجارت" width="40px"/>
                            </td>
                            <td>
                                <img src="@Url.Content("~/Content/images/PECLogo.gif")" title="بانک پارسیان" width="40px"/>
                            </td>*@
                        </tr>
                        <tr align="center">
                            @for (var i = 0; i < picmnu.Count;i++ )
                            {
                                <td>
                                @Html.RadioButton("Bank", picmnu[i].BankId)
                            </td>
                            }	
                            @*<td>
                                @Html.RadioButton("Bank", 1, new { @id = "CityBank" })
                            </td>
                            <td>
                                @Html.RadioButton("Bank", 2, new { @id = "MelatBank" })
                            </td>
                            <td>
                                @Html.RadioButton("Bank", 3, new { @id = "MeliBank" })
                            </td>
                            <td>
                                @Html.RadioButton("Bank", 4, new { @id = "TejaratBank" })
                            </td>
                            <td>
                                @Html.RadioButton("Bank", 5, true, new { @id = "Parsian" })
                            </td>*@
                        </tr>
                    </table>
                    <br />
                    @Avarez.Helper.winClass.Buttons("Print", "چاپ جرئیات", "Blank")
                    @Avarez.Helper.winClass.Buttons("PcPos", "پرداخت با Pos", "Next")
                    @Avarez.Helper.winClass.Buttons("next", "ادامه", "Next")
                    @if (Avarez.Controllers.Users.Permossions.haveAccess(Convert.ToInt32(Session["UserId"]), 248))
                    {
                        @Avarez.Helper.winClass.Buttons("Fish", "فیش", "yes")
                    }
                    @Avarez.Helper.winClass.Buttons("Mafasa", "مفاصا", "yes")
                    @Avarez.Helper.winClass.Buttons("OfficeRecipt","رسید دفتر","yes")
                    @Avarez.Helper.winClass.Buttons("exit2", "خروج", "exit")
                </center>
            </div>
        </div>
        <script type="text/javascript">
    function Resid() {
        var entityGrid = $("#VarizihaGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem) {
            var id = selectedItem.fldID;
            window.open('/inFacture/Receipt?id=' + id + '&Type=' + 1);
        }
    }
    function ExMadrak() {
        var entityGrid = $("#SavabeghGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem) {
            var id = selectedItem.fldID;
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + id + "&type=CarEx'/> ");
        }
    }
    function FishMadrak() {
        var entityGrid = $("#VarizihaGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem) {
            var id = selectedItem.fldID;
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + id + "&type=Collection'/> ");
        }
    }
    function calcstart() {
        //$('#Lock').show();
    }
    //var d;
    function calcend() {
        //$('#Lock').hide();
    }
    function load() {
        var f = $('.k-button');
        f.removeAttr('href');
    }

    var isWinOpen = false;
    var carid;
    var barcode;
    var Tarikh;
    var PosIPId = 0;

    var shasi_motor_vin = "";
    $("document").ready(function () {
        $("#next").button();
        $("#search").button();
        $("#exit2").button();
        $("#Fish").button();
        $('#Mafasa').button();
        $('#EditFish').button();
        $('#Print').button();
        $('#Tree').button();
        $('#ChMalek').button();
        $('#btnEditSavabegh').button();
        $('#btnAgainCalc').button();
        $('#PcPos').button();
        $('#OfficeRecipt').button();        
        $("#Baygani").button();
        $("#Bargsabz").button();
        $("#Cart").button();
        $("#CartBack").button();
        $("#Sanad").button();
        $("#EditPics").button();
        $("#EditPics").click(function () {
            if (isWinOpen == false) {
                windowAppend('body', '@Url.Content("~/EditCarFilePics/Index")' + '?carid=' + carid);
                isWinOpen = true;
            }
        });
        $("#Bargsabz").click(function () {
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + carid + "&type=Bargsabz'/> ");
        });
        $("#Cart").click(function () {
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + carid + "&type=Cart'/> ");
        });
        $("#CartBack").click(function () {
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + carid + "&type=CartBack'/> ");
        });
        $("#Sanad").click(function () {
            windowAppend('body', '/home/PreviewFile');
            $('#image').html("<br/><img src='/Home/showFile?id=" + carid + "&type=Sanad'/> ");
        });
        PosIPId = '@ViewBag.PosIPId';
        if (PosIPId != 0)
            $('#PcPos').show();
        else
            $('#PcPos').hide();

        Dialog1 = 0;
        $("#exit2").click(function () {
            $("#Facture").remove();
        });

        $('#PcPos').click(function () {
            $.ajax({
                url: '/InFacture/GetPicStatus',
                datatype: 'json',
                data: { id: carid },
                error: function (xhr, status, error) {
                    alert(xhr + status);
                },
                success: function (result) {
                    if (result.status == false) {
                        var str = "";
                        if (result.carfile == 1)
                            str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                        if (result.carext == 1)
                            str += " انتقال سوابق ";
                        if (result.coll == 1)
                            str += " واریزی علی الحساب ";
                        alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                    } else {
                        var URL = '@Url.Content("~/InFacture/PcPosPay")';
                        var Mablagh = $('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "");
                        URL = URL + "?Mablagh=" + Mablagh + "&PosIPId=" + PosIPId + "&carid=" + carid;
                        $.ajax({
                            type: "POST",
                            url: URL,
                            success: function (result) {
                                windowAppend("body", "/metro/error");
                                $("#message").html(result.data);
                                switch (result.state) {
                                    case 0:
                                        $("#error .wintitle").html("ذخیره موفق");
                                        break;
                                    case 1:
                                        $("#error .wintitle").html("خطا");
                                        break;
                                }
                            },
                            failure: function (data) {
                                alert(data.data);
                            }
                        });
                    }
                }
            });
           
        });

        
        $("#Print").click(function () {
            //window.open("/AppReports/RptJoziyatAvarez" + '?carid=' + carid);
            if (isWinOpen == false) {
                isWinOpen = true;
                windowAppend('body', '/Home/PreviewRptPDFBox');
                var t = "/AppReports/RptJoziyatAvarez" + '?carid=' + carid;
                $('#pdf').html("<br/><object style='width: 900px;height: 500px;border: 1px solid #ccc;' id='pdfbox' type='application/pdf' data='" + t + "'></object> ");
            }
        });
        
        $("#Tree").click(function () {
            if (isWinOpen == false) {
                windowAppend('body', '@Url.Content("~/ListImageInTree/Index")' + '?carid=' + carid);
                isWinOpen = true;
            }
        });
        $("#Baygani").click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/TempArchive/Index")' + '?id=' + carid + '&state=1';
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);
            }
        });
        
        $("#EditFish").click(function () {
            if (isWinOpen == false) {
                windowAppend('body', '@Url.Content("~/EditCar/Index")' + '?carid=' + carid);
                isWinOpen = true;
            }
        });
        $("#btnEditSavabegh").click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/Savabegh/Index")' + '?id=' + carid + '&state=0';
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);
            }
        });
        $('#ChMalek').click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/ChCarFilePelaquSearch/Index")' + '?id=' + carid;
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);

            }
        });
        $('#Facture').on('keyup', 'input', function (event) {
            if (event.which == 13) {
                var inputs = $('#Facture').find(':input:visible');
                inputs.eq(inputs.index(this) + 1).focus();
            }
        });
        $('#btnAgainCalc').click(function () {
            $('#Lock').show();
            $.ajax({
                type: "post",
                url: '/inFacture/Fill',
                success: function (data1) {
                    var mo = data1;
                    $('#fldPlaqueNum').val(data1.plaq);
                    $('#txtMalek').val(data1.Malek);
                    $('#txtCarMake').val(data1.make);
                    $('#txtCarAccountTypes').val(data1.account);
                    $('#txtCarCabin').val(data1.cabin);
                    $('#txtSystem').val(data1.syst);
                    $('#txtModel').val(data1.modell);
                    $('#txtClass').val(data1.classs);
                    $('#txtMotor').val(data1.motor);
                    $('#txtShasi').val(data1.shasi);
                    $('#txtColor').val(data1.color);
                    $('#txtYear').val(data1.year);
                    $('#txtDateP').val(data1.datep);
                    $('#txtDate').val(data1.date);
                    $('#VIN').val(data1.vin);
                    $('#txtCodeMeli').val(data1.CodeMeli);
                    carid = data1.carId;

                    shasi_motor_vin = "";
                    var shasi = ""; var motor = ""; var vin = "";
                    if (data1.shasi == "" || data1.motor == "" || data1.vin == "") {
                        if (data1.shasi == "")
                            shasi = " شماره شاسی،";
                        if (data1.motor == "")
                            motor = " شماره موتور،";
                        if (data1.vin == "")
                            vin = " VIN،";

                        shasi_motor_vin = "ثبت " + shasi + motor + vin + " ضروری می باشد.";
                    }

                    //$.ajax({
                    //    url: '/InSearchFile/CheckHaveArchive',
                    //    datatype: 'json',
                    //    data: { carid: carid },
                    //    error: function (xhr, status, error) {
                    //        alert(xhr + status);
                    //    },
                    //    success: function (data) {
                    //        if (data.Msg != "") {
                    //            shasi_motor_vin = "ثبت " + shasi + motor + vin + " مدارک در بایگانی دیجیتال" + " ضروری می باشد.";
                    //        }
                    //        if (shasi_motor_vin != "") {
                    //            windowAppend("body", "/metro/error");
                    //            $("#message").html(shasi_motor_vin);
                    //        }
                    //    }
                    //});
                    $.ajax({
                        url: '/InFacture/GetPicStatus',
                        datatype: 'json',
                        data: { id: carid },
                        error: function (xhr, status, error) {
                            alert(xhr + status);
                        },
                        success: function (result) {
                            if (result.status == false) {
                                var str = "";
                                if (result.carfile == 1)
                                    str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                                if (result.carext == 1)
                                    str += " انتقال سوابق ";
                                if (result.coll == 1)
                                    str += " واریزی علی الحساب ";
                                alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                            }
                        }
                    });
                },
                failure: function (data) {
                    alert(data.data);
                }
            });

            $.ajax({
                type: "get",
                url: '/inFacture/calc',
                success: function (data) {
                    $("#MoGrid").data("kendoGrid").dataSource.data(data.bedehi);
                    $('#lblMablagh').html(accounting.formatNumber(data.mablagh).toString() + ' ریال'); //pardakhti).toString()) + ' ریال');
                    //$('#lblshGhabz').html(data.shGhabz + " ");
                    //$('#lblshPardakht').html(data.shPardakht);
                    barcode = data.barcode;
                    if (data.msg != '') {
                        if (data.State == 1) {
                            windowAppend("body", "/metro/error");
                            $("#message").html(data.msg);
                            $("#error .wintitle").html("هشدار");
                        }
                        else if (data.State == 2) {
                            var URL = '@Url.Content("~/InFacture/SendToSupporter")';
                            URL = URL + "/?Year=" + data.Year + "&CarClassId=0";
                            windowAppend("body", URL);
                            $("#message1").html(data.msg);
                            $("#error .wintitle").html("هشدار");
                        }
                    }
                    $('#Lock').hide();

                    $("#SavabeghGrid").data("kendoGrid").dataSource.read();
                    $("#VarizihaGrid").data("kendoGrid").dataSource.read();
                    $.ajax({
                        url: '/InFacture/CheckExistFish',
                        datatype: 'json',
                        data: { carid: carid, showmoney: $('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "") },
                        error: function (xhr, status, error) {
                            alert(xhr + status);
                        },
                        success: function (result) {
                            if (result.state != 0) {
                                $('#lblMsg').html('برای پرونده انتخابی فیش صادر و پرداخت نگردیده است.');
                            }
                            
                        }
                    });
                   
                },
                failure: function (data) {
                    alert(data.data);
                }
            });
        });
        
        $('#Lock').show();
        $('#GridLocation').html($('#Grid').html());
        $.ajax({
            type: "post",
            url: '/inFacture/Fill',
            success: function (data) {
                var mo = data;
                $('#fldPlaqueNum').val(data.plaq);
                $('#txtMalek').val(data.Malek);
                $('#txtCarMake').val(data.make);
                $('#txtCarAccountTypes').val(data.account);
                $('#txtCarCabin').val(data.cabin);
                $('#txtSystem').val(data.syst);
                $('#txtModel').val(data.modell);
                $('#txtClass').val(data.classs);
                $('#txtMotor').val(data.motor);
                $('#txtShasi').val(data.shasi);
                $('#txtColor').val(data.color);
                $('#txtYear').val(data.year);
                $('#txtDateP').val(data.datep);
                $('#txtDate').val(data.date);
                $('#VIN').val(data.vin);
                $('#txtCodeMeli').val(data.CodeMeli);
                carid = data.carId;
                //$("#CalcGrid").data("kendoGrid").dataSource.data(mo.bedehi);

                var shasi = ""; var motor = ""; var vin = "";
                if (data.shasi == "" || data.motor == "" || data.vin == "") {
                    if (data.shasi == "")
                        shasi = " شماره شاسی،";
                    if (data.motor == "")
                        motor = " شماره موتور،";
                    if (data.vin == "")
                        vin = " VIN،";

                    shasi_motor_vin = "ثبت " + shasi + motor + vin + " ضروری می باشد.";
                    //windowAppend("body", "/metro/error");
                    //$("#message").html(shasi_motor_vin);
                }


                //$.ajax({
                //    url: '/InSearchFile/CheckHaveArchive',
                //    datatype: 'json',
                //    data: { carid: carid },
                //    error: function (xhr, status, error) {
                //        alert(xhr + status);
                //    },
                //    success: function (data) {
                //        if (data.Msg != "") {
                //            shasi_motor_vin = "ثبت " + shasi + motor + vin + " مدارک در بایگانی دیجیتال" + " ضروری می باشد.";
                //        }
                //        if (shasi_motor_vin != "") {
                //            windowAppend("body", "/metro/error");
                //            $("#message").html(shasi_motor_vin);
                //        }
                //    }
                //});

                $.ajax({
                    type: "get",
                    url: '/inFacture/calc',
                    success: function (data) {
                        $("#MoGrid").data("kendoGrid").dataSource.data(data.bedehi);
                        $('#lblMablagh').html(accounting.formatNumber(data.mablagh).toString() + ' ریال'); //pardakhti).toString()) + ' ریال');
                        //$('#lblshGhabz').html(data.shGhabz + " ");
                        //$('#lblshPardakht').html(data.shPardakht);
                        barcode = data.barcode;
                        if (data.msg != '') {
                            var URL = '@Url.Content("~/InFacture/SendToSupporter")';
                            URL = URL + "/?Year=" + data.Year + "&CarClassId=0";
                            windowAppend("body", URL);
                            $("#message1").html(data.msg);
                            $("#error .wintitle").html("هشدار");
                        }
                        $('#Lock').hide();
                        $.ajax({
                            url: '/InFacture/CheckExistFish',
                            datatype: 'json',
                            data: { carid: carid, showmoney: $('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "") },
                            error: function (xhr, status, error) {
                                alert(xhr + status);
                            },
                            success: function (result) {
                                if (result.state != 0) {
                                    $('#lblMsg').html('برای پرونده انتخابی فیش صادر و پرداخت نگردیده است.')
                                }
                            }
                        });
                    },
                    failure: function (data) {
                        alert(data.data);
                    }
                });




            },
            failure: function (data) {
                alert(data.data);
            }
        });

        $('#Fish').click(function () {
            //if (shasi_motor_vin != "") {
            //    windowAppend("body", "/metro/error");
            //    $("#message").html(shasi_motor_vin);
            //}
            //else {
                $.ajax({
                    url: '/InFacture/CheckBlackList',
                    datatype: 'json',
                    data: { carid: carid },
                    error: function (xhr, status, error) {
                        alert(xhr + status);
                    },
                    success: function (result) {
                        if (result.Msg != "") {
                            windowAppend("body", "/metro/error");
                            $("#message").html(result.Msg);
                        }
                        else if (result.Msg == "") {
                            $.ajax({
                                url: '/InFacture/GetPicStatus',
                                datatype: 'json',
                                data: { id: carid },
                                error: function (xhr, status, error) {
                                    alert(xhr + status);
                                },
                                success: function (result) {
                                    if (result.status == false) {
                                        var str = "";
                                        if (result.carfile == 1)
                                            str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                                        if (result.carext == 1)
                                            str += " انتقال سوابق ";
                                        if (result.coll == 1)
                                            str += " واریزی علی الحساب ";
                                        alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                                    } else {
                                        $.ajax({
                                            url: '/InFacture/CheckExistFish',
                                            datatype: 'json',
                                            data: { carid: carid, showmoney: $('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "") },
                                            error: function (xhr, status, error) {
                                                alert(xhr + status);
                                            },
                                            success: function (result) {
                                                if (result.state == 0) {
                                                    //                                window.open('/inFacture/FishReport/' + carid, '_blank');
                                                    //                                window.focus();
                                                    if (isWinOpen == false) {
                                                        isWinOpen = true;
                                                        windowAppend('body', '/Home/PreviewRptPDFBox');
                                                        var t = '/inFacture/FishReport/' + carid;
                                                        $('#pdf').html("<br/><object style='width: 900px;height: 500px;border: 1px solid #ccc;' id='pdfbox' type='application/pdf' data='" + t + "'></object> ");
                                                    }
                                                }
                                                else {
                                                    var URL = '@Url.Content("~/metro/FishYesNomsg")';
                                                    URL = URL + "?id=" + result.PeacockeryId + "&mablagh=" + $('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "") + "&URL=" + '@Url.Content("~/InFacture/_FishReport")';
                                                    windowAppend("body", URL);
                                                    $("#message").html('آیا مایل به چاپ فیش المثنی هستید؟');
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                            
                        }
                    }
                });
            //}
        });
        $('#OfficeRecipt').click(function () {
            $.ajax({
                url: '/InFacture/GetPicStatus',
                datatype: 'json',
                data: { id: carid },
                error: function (xhr, status, error) {
                    alert(xhr + status);
                },
                success: function (result) {
                    if (result.status == false) {
                        var str = "";
                        if (result.carfile == 1)
                            str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                        if (result.carext == 1)
                            str += " انتقال سوابق ";
                        if (result.coll == 1)
                            str += " واریزی علی الحساب ";
                        alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                    }
                    else {
                        if (shasi_motor_vin != "") {
                            windowAppend("body", "/metro/error");
                            $("#message").html(shasi_motor_vin);
                        }
                        else {
                            //window.open('/inFacture/Mafasa/' + carid);
                            if (isWinOpen == false) {
                                isWinOpen = true;
                                windowAppend('body', '/Home/PreviewRptPDFBox');
                                var t = '/inFacture/OfficeRecipt/' + carid;
                                $('#pdf').html("<br/><object style='width: 900px;height: 500px;border: 1px solid #ccc;' id='pdfbox' type='application/pdf' data='" + t + "'></object> ");
                            }

                        }
                    }
                }
            });
        });
        $('#Mafasa').click(function () {
            $.ajax({
                url: '/InFacture/GetPicStatus',
                datatype: 'json',
                data: { id: carid },
                error: function (xhr, status, error) {
                    alert(xhr + status);
                },
                success: function (result) {
                    if (result.status == false) {
                        var str = "";
                        if (result.carfile == 1)
                            str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                        if (result.carext == 1)
                            str += " انتقال سوابق ";
                        if (result.coll == 1)
                            str += " واریزی علی الحساب ";
                        alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                    } else {
                        if (shasi_motor_vin != "") {
                            windowAppend("body", "/metro/error");
                            $("#message").html(shasi_motor_vin);
                        }
                        else {
                            if ($('#lblMablagh').html().replace(" ریال", "").replace(",", "") <= 10000) {
                                //window.open('/inFacture/Mafasa/' + carid);
                                if (isWinOpen == false) {
                                    isWinOpen = true;
                                    windowAppend('body', '/Home/PreviewRptPDFBox');
                                    var t = '/inFacture/Mafasa/' + carid;
                                    $('#pdf').html("<br/><object style='width: 900px;height: 500px;border: 1px solid #ccc;' id='pdfbox' type='application/pdf' data='" + t + "'></object> ");
                                }
                            }
                            else {
                                alert('خودرو انتخاب شده بدهکار است و امکان صدور مفاصا وجود ندارد.');
                            }
                        }
                    }
                }
            });
            
        });

        $('#search').click(function () {
            Reload('/inSearchFile/Reload', 'Grid', $('#cboSearchFiald').val(), $('#txtSearch1').val(), $('#txtSearch2').val());
        });

        $('#cboSearchFiald').change(function () {
            if ($('#cboSearchFiald').val() == 0) {
                $('#span2').attr('style', 'display:none;');
                $('#span1').html('VIN:');
                $('#value2').val('');
            }
            else {
                $('#span2').attr('style', '');
                $('#span1').html('شماره موتور:');
                $('#value2').val('');
            }
        });

        $('#next').click(function () {
            $.ajax({
                url: '/InFacture/GetPicStatus',
                datatype: 'json',
                data: { id: carid },
                error: function (xhr, status, error) {
                    alert(xhr + status);
                },
                success: function (result) {
                    if (result.status == false) {
                        var str = "";
                        if (result.carfile == 1)
                            str += " پرونده خودرو(برگ سبز، کارت خودرو، سند کارخانه) ";
                        if (result.carext == 1)
                            str += " انتقال سوابق ";
                        if (result.coll == 1)
                            str += " واریزی علی الحساب ";
                        alert("تصاویر مربوط به " + str + " بارگذاری نشده است");
                    } else {
                        if (shasi_motor_vin != "") {
                            windowAppend("body", "/metro/error");
                            $("#message").html(shasi_motor_vin);
                        }
                        else {
                            var URL = '@Url.Content("~/infacture/GoToOnlinePay")';
                            URL = URL;
                            var bankid;
                            var h = document.getElementsByName('Bank');
                            for (var i = 0; i < h.length; i++) {
                                if (h[i].checked == true)
                                    bankid = h[i].value;
                            }
                            //if (h[0].checked == true) {
                            //    bankid = 20;
                            //} else if (h[1].checked == true) {
                            //    bankid = 3;
                            //} else if (h[2].checked == true) {
                            //    bankid = 1;
                            //} else if (h[3].checked == true) {
                            //    bankid = 2;
                            //} else if (h[4].checked == true) {
                            //    bankid = 15;
                            //}
                            if (parseInt($('#lblMablagh').html().replace(" ریال", "").replace(",", "").replace(",", "").replace(",", "")) >= 1000) {
                                //if (bankid == 15)
                                windows("#win", URL + "?Amount=" + $('#lblMablagh').html().replace(" ریال", "").replace(",", "") + '&CarId=' + carid + '&BankId=' + bankid);
                                //else
                                //    alert('شما فقط مجاز به انتخاب بانک پارسیان هستید.');
                            }
                            else
                                alert('مبلغ پرداخت کمتر از میزان مجاز برای پرداخت اینترنتی است.');
                        }
                    }
                }
            });
            
        });
    });
    function Reload(Url, gridname, field, value1, value2) {
        var grid = $('#' + gridname).data('kendoGrid');
        $.ajax({
            url: Url,
            type: 'get',
            datatype: 'json',
            data: { field: field, value1: value1, value2: value2 },
            error: function (xhr, status, error) {
                alert(xhr + status);
            },
            success: function (result) {
                $("#" + gridname).data("kendoGrid").dataSource.data(result);
            }

        });
    }

    function PostForm(datas, url, id) {
        var sendInfo = datas;
        $('#Lock').show();
        $.ajax({
            type: "POST",
            url: url,
            data: sendInfo,
            datatype: "json",
            success: function (data) {
                var m = data;
                windowAppend("body", "/metro/error");
                $("#message").html(m.data);
                $("#fldId").val(m.id);
                switch (m.state) {
                    case 0:
                        $("#error .wintitle").html("ذخیره موفق");
                        break;
                    case 1:
                        $("#error .wintitle").html("خطا");
                        break;
                }
                var url = '@Url.Action("Reload", "Owner")';
                Reload(url, 'Grid', '0', '', 30, 1);
                $('#Lock').hide();

            },
            failure: function (data) {
                alert(data.data);
            }
        });
    }
</script>
        <div id="dialog" title="فیش">
            <div id="content">
            </div>
        </div>
    </div>
    @*<div id="Grid" style="display: none">
    </div>*@ @*@(Html.Kendo().PanelBar()
        .Name("panelbar3")
        .Items(panelbar =>
        {
            panelbar.Add().Text("ریز محاسبات")
                .Expanded(true)
                .Content(@*@
    <div class="k-rtl demo-section">
        @(Html.Kendo().Grid<Avarez.Models.sp_jCalcCarFile>()
                .Name("MoGrid")
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldyear).Title("سال").Width(50);
                    columns.Bound(p => p.fldFirstPrice).Title("عوارض").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldCurectPrice).Title("مبلغ موثر").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldValueAdded).Title("تبصره ب ماده43").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldFinalPrice).Title("مبلغ نهایی").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldFine).Title("جریمه").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldCountMonth).Title("تعداد ماه/روز").Width(100);
                    columns.Bound(p => p.fldDiscount).Title("تخفیف").Format("{0:#,###0}").Width(100);
                    columns.Bound(p => p.fldDept).Title("جمع کل").Format("{0:#,###0}").Width(100);
                })
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Pageable()
            .Scrollable()
            .DataSource(data =>
                data.Ajax()
                .PageSize(30)
                .Model(mo => mo.Field(p => p.fldyear))
                //.Read("calc", "inFacture").Events(h => { h.RequestStart("calcstart"); h.RequestEnd("calcend");})                
            )//.Events(h=>h.DataBound("DataBound"))
        )
    </div>@*);*@ @*})
        )*@
    @(Html.Kendo().PanelBar()
        .Name("panelbar1")
        .Items(panelbar =>
        {
            panelbar.Add().Text("سوابق خودرو")
                .Expanded(true)
                .Content(@<div class="k-rtl demo-section">
                    @(Html.Kendo().Grid<Avarez.Models.sp_CarExperienceSelect>()
                .Name("SavabeghGrid")
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldID).Title("کد").Visible(false);
                    columns.Bound(p => p.fldName).Title("شهرداری").Width(100);
                    columns.Bound(p => p.fldLetterNumber).Title("ش نامه").Width(100);
                    columns.Bound(p => p.fldStartDate).Title("از تاریخ").Width(100);
                    columns.Bound(p => p.fldEndDate).Title("تا تاریخ").Width(100);
                    columns.Bound(p => p.fldPlaqueNumber).Title("ش پلاک").Width(170);
                    columns.Bound(p => p.fldUserName).Title("كاربر").Width(170);
                    columns.Bound(p => p.fldDesc).Title("توضیحات").Width(170);
                    columns.Command(c => c.Custom("ExMadrak").Click("ExMadrak").HtmlAttributes(new { @style = "Color:Black;" }).Text("مدرک")).Width(100);
                })
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Pageable()
            .Scrollable()
            .DataSource(data =>
                data.Ajax()
                .PageSize(10)
                            .Read("Savabegh", "inFacture")
                            .Events(h => { h.RequestStart("calcstart"); h.RequestEnd("calcend"); })
            )

        )
                </div>);
        })
        )
    @(Html.Kendo().PanelBar()
        .Name("panelbar2")
        .Items(panelbar =>
        {
            panelbar.Add().Text("واریزی ها")
                .Expanded(true)
                .Content(@<div class="k-rtl demo-section">
                    @(Html.Kendo().Grid<Avarez.Models.rpt_Receipt>()
                .Name("VarizihaGrid")
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldID).Title("کد").Visible(false);
                    columns.Bound(p => p.fldCollectionDate).Title("تاریخ");
                    columns.Bound(p => p.fldPrice).Title("مبلغ").Format("{0:#,###0}");
                    columns.Bound(p => p.fldMunName).Title("صاحب حساب");
                    columns.Bound(p => p.BankName).Title("بانک عامل");
                    columns.Bound(p => p.UserName).Title("کاربر ثبت کننده");
                    columns.Bound(p => p.sabtkonande).Title("کاربر صادر کننده");
                    columns.Command(c => c.Custom("Resid").Click("Resid").HtmlAttributes(new { @style = "Color:Black;" }).Text("رسید"));
                    columns.Command(c => c.Custom("FishMadrak").Click("FishMadrak").HtmlAttributes(new { @style = "Color:Black;" }).Text("مدرک"));
                })
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Pageable()
            .Scrollable()
            .DataSource(data =>
                data.Ajax()
                .PageSize(10)
                            .Read("Variziha", "inFacture").Events(h => { h.RequestStart("calcstart"); h.RequestEnd("calcend"); })
            ).Events(h => h.DataBound("load"))
        )
                </div>);
        })
        )
</div>
