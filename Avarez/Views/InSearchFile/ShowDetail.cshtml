@using Kendo.Mvc.UI;
<div class="modal" id="Facture">
    <script src="@Url.Content("~/Content/Base.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/web/kendo.common.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/web/kendo.default.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/web/kendo.rtl.min.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/console.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.web.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/prettify.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.aspnetmvc.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.splitter.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/cultures/kendo.fa-IR.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/accounting.js")" type="text/javascript"></script>
    <script>
        
    </script>
    @{
        Avarez.Models.cartaxEntities car = new Avarez.Models.cartaxEntities();
        var picmnu = car.sp_SelectNameBankAndMunForBankInformation(Convert.ToInt32(Session["UserMnu"])).ToList();
    }
    <div>
        
        <br />
        <div>
            <div>
                <table>
                    <tr>
                        <td align="left">
                            نام و خانوادگی مالک:
                        </td>
                        <td>
                            @Html.TextBox("txtMalek", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            کد ملی:
                        </td>
                        <td>
                            @Html.TextBox("txtCodeMeli", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            نوع ساخت:
                        </td>
                        <td>
                            @Html.TextBox("txtCarMake", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            نوع کاربری:
                        </td>
                        <td>
                            @Html.TextBox("txtCarAccountTypes", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            نوع کابین:
                        </td>
                        <td>
                            @Html.TextBox("txtCarCabin", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            سیستم خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtSystem", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            تیپ خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtModel", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            کلاس خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtClass", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            شماره موتور:
                        </td>
                        <td>
                            @Html.TextBox("txtMotor", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            شماره شاسی:
                        </td>
                        <td>
                            @Html.TextBox("txtShasi", null, new { @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            رنگ خودرو:
                        </td>
                        <td>
                            @Html.TextBox("txtColor", null, new { @readonly = "true" })
                        </td>
                        <td align="left">
                            سال تولید:
                        </td>
                        <td>
                            @Html.TextBox("txtYear", null, new { @dir = "ltr", @style = "width: 30px;", @id = "txtYear", @maxlength = "4", @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            VIN:
                        </td>
                        <td dir='rtl'>
                            @Html.TextBox("VIN", null, new { @dir = "ltr", @style = "width:150px;background-color:rgb(255, 202, 153);", @id = "VIN", @readonly = "true", enable = "false" })
                        </td>
                        <td align="left">
                            شماره پلاک:
                        </td>
                        <td>
                            @Html.TextBox("fldPlaqueNum", null, new { @dir = "rtl", @style = "width: 150px;background-color:rgb(255, 202, 153);", @id = "fldPlaqueNum", @readonly = "true" })
                        </td>
                    </tr>
                    <tr>
                        <td align="left">
                            تاریخ پلاک گذاری:
                        </td>
                        <td>
                            @Html.TextBox("txtDateP", null, new { @dir = "ltr", @style = "width: 70px;", @readonly = "true" })
                        </td>
                        <td align="left">
                            تاریخ اولین بیمه:
                        </td>
                        <td colspan="3">
                            @Html.TextBox("txtDate", null, new { @dir = "ltr", @style = "width: 70px;", @readonly = "true" })
                        </td>
                    </tr>

                    <tr>
                        <td></td>
                        <td>
                            <button id="Tree" style="font-size: 9px;" title="مشاهده بایگانی دیجیتال">
                                مشاهده بایگانی دیجیتال
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="Baygani" style="font-size: 9px;" title="ثبت بایگانی دیجیتال">
                                ثبت بایگانی دیجیتال
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="EditFish" style="font-size: 9px;" title="ویرایش خودرو">
                                ویرایش مشخصات خودرو
                            </button>
                        </td>
                        <td colspan="2">
                            <button id="ChMalek" style="font-size: 9px;" title="تعویض مالک">
                                تعویض مالک
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>
                            <button id="btnEditSavabegh" style="font-size: 9px;" title="ویرایش سوابق">
                                ویرایش سوابق
                            </button>
                        </td>
                        <td colspan="2">
                            
                        </td>
                    </tr>
                </table>
            </div>
            <div>
                <center>
                    @Avarez.Helper.winClass.Buttons("Fish", "صورتحساب", "yes")
                    @Avarez.Helper.winClass.Buttons("exit2", "خروج", "exit")
                </center>
            </div>
        </div>
        <div id="dialog-confirm" title="هشدار" style="display:none;">
            <p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>درصورت ادامه از شارژ شمار کسر خواهد شد. آیا مطمئن هستید؟</p>
        </div>
        <script type="text/javascript">
    function Resid() {
        var entityGrid = $("#VarizihaGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem) {
            var id = selectedItem.fldID;
            window.open('/inFacture/Receipt?id=' + id + '&Type=' + 1);
        }
    }
    function calcstart() {
        //$('#Lock').show();
    }
    //var d;
    function calcend() {
        //$('#Lock').hide();
    }
    function load() {
        var f = $('.k-button');
        f.removeAttr('href');
    }

    var isWinOpen = false;
    var carid;
    var barcode;
    var Tarikh;
    var PosIPId = 0;

    var shasi_motor_vin = "";
    $("document").ready(function () {
        $("#next").button();
        $("#search").button();
        $("#exit2").button();
        $("#Fish").button();
        $('#Mafasa').button();
        $('#EditFish').button();
        $('#Print').button();
        $('#Tree').button();
        $('#ChMalek').button();
        $('#btnEditSavabegh').button();
        $('#btnAgainCalc').button();
        $('#PcPos').button();
        $("#Baygani").button();

        

        Dialog1 = 0;
        $("#exit2").click(function () {
            $("#Facture").remove();
        });

        

        $("#Tree").click(function () {
            if (isWinOpen == false) {
                windowAppend('body', '@Url.Content("~/ListImageInTree/Index")' + '?carid=' + carid);
                isWinOpen = true;
            }
        });
        $("#Baygani").click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/TempArchive/Index")' + '?id=' + carid + '&state=1';
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);
            }
        });

        $("#EditFish").click(function () {
            if (isWinOpen == false) {
                windowAppend('body', '@Url.Content("~/EditCar/Index")' + '?carid=' + carid);
                isWinOpen = true;
            }
        });
        $("#btnEditSavabegh").click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/Savabegh/Index")' + '?id=' + carid + '&state=0';
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);
            }
        });
        $('#ChMalek').click(function () {
            if (Dialog1 == 0) {
                Dialog1 = 1;
                var URL = '@Url.Content("~/ChCarFilePelaquSearch/Index")' + '?id=' + carid;
                windowAppend('body', '@Url.Content("~/CommonWin/index2")');
                windows("#CommonContent1", URL);

            }
        });
        $('#Facture').on('keyup', 'input', function (event) {
            if (event.which == 13) {
                var inputs = $('#Facture').find(':input:visible');
                inputs.eq(inputs.index(this) + 1).focus();
            }
        });
        

        $('#Lock').show();
        $('#GridLocation').html($('#Grid').html());
        $.ajax({
            type: "post",
            url: '/inFacture/Fill',
            success: function (data) {
                var mo = data;
                $('#fldPlaqueNum').val(data.plaq);
                $('#txtMalek').val(data.Malek);
                $('#txtCarMake').val(data.make);
                $('#txtCarAccountTypes').val(data.account);
                $('#txtCarCabin').val(data.cabin);
                $('#txtSystem').val(data.syst);
                $('#txtModel').val(data.modell);
                $('#txtClass').val(data.classs);
                $('#txtMotor').val(data.motor);
                $('#txtShasi').val(data.shasi);
                $('#txtColor').val(data.color);
                $('#txtYear').val(data.year);
                $('#txtDateP').val(data.datep);
                $('#txtDate').val(data.date);
                $('#VIN').val(data.vin);
                $('#txtCodeMeli').val(data.CodeMeli);
                carid = data.carId;
                //$("#CalcGrid").data("kendoGrid").dataSource.data(mo.bedehi);

                var shasi = ""; var motor = ""; var vin = "";
                if (data.shasi == "" || data.motor == "" || data.vin == "") {
                    if (data.shasi == "")
                        shasi = " شماره شاسی،";
                    if (data.motor == "")
                        motor = " شماره موتور،";
                    if (data.vin == "")
                        vin = " VIN،";

                    shasi_motor_vin = "ثبت " + shasi + motor + vin + " ضروری می باشد.";
                    //windowAppend("body", "/metro/error");
                    //$("#message").html(shasi_motor_vin);
                }

                $('#Lock').hide();
                //$.ajax({
                //    url: '/InSearchFile/CheckHaveArchive',
                //    datatype: 'json',
                //    data: { carid: carid },
                //    error: function (xhr, status, error) {
                //        alert(xhr + status);
                //    },
                //    success: function (data) {
                //        if (data.Msg != "") {
                //            shasi_motor_vin = "ثبت " + shasi + motor + vin + " مدارک در بایگانی دیجیتال" + " ضروری می باشد.";
                //        }
                //        if (shasi_motor_vin != "") {
                //            windowAppend("body", "/metro/error");
                //            $("#message").html(shasi_motor_vin);
                //        }
                //    }
                //});

               



            },
            failure: function (data) {
                alert(data.data);
            }
        });

        $('#Fish').click(function () {
            var id = '@ViewBag.id';
            $.ajax({
                url: '/InSearchFile/CheckBlackList',
                datatype: 'json',
                data: { carid: id },
                error: function (xhr, status, error) {
                    alert(xhr + status);
                },
                success: function (result) {
                    if (result.Msg != "") {
                        windowAppend("body", "/metro/error");
                        $("#message").html(result.Msg);
                    }
                    else if (result.Msg == "") {
                        $.ajax({
                            url: '/InSearchFile/GetTrnStatus',
                            data: { CarId: id },
                            success: function (d) {
                                if (d == "0") {
                                    $("#dialog-confirm").dialog({
                                        resizable: false,
                                        height: "auto",
                                        width: 350,
                                        modal: true,
                                        buttons: {
                                            "بله": function () {
                                                var URL = '@Url.Content("~/infacture/Index")';
                                                URL = URL;
                                                windows("#win", URL + "/" + id);
                                                $(this).dialog("close");
                                            },
                                            "خیر": function () {
                                                $(this).dialog("close");
                                            }
                                        }
                                    });
                                } else {
                                    var URL = '@Url.Content("~/infacture/Index")';
                                    URL = URL;
                                    windows("#win", URL + "/" + id);
                                }
                            }
                        });
                    }
                }
            });
        });

        

        $('#search').click(function () {
            Reload('/inSearchFile/Reload', 'Grid', $('#cboSearchFiald').val(), $('#txtSearch1').val(), $('#txtSearch2').val());
        });

        $('#cboSearchFiald').change(function () {
            if ($('#cboSearchFiald').val() == 0) {
                $('#span2').attr('style', 'display:none;');
                $('#span1').html('VIN:');
                $('#value2').val('');
            }
            else {
                $('#span2').attr('style', '');
                $('#span1').html('شماره موتور:');
                $('#value2').val('');
            }
        });

        
    });
    function Reload(Url, gridname, field, value1, value2) {
        var grid = $('#' + gridname).data('kendoGrid');
        $.ajax({
            url: Url,
            type: 'get',
            datatype: 'json',
            data: { field: field, value1: value1, value2: value2 },
            error: function (xhr, status, error) {
                alert(xhr + status);
            },
            success: function (result) {
                $("#" + gridname).data("kendoGrid").dataSource.data(result);
            }

        });
    }

    function PostForm(datas, url, id) {
        var sendInfo = datas;
        $('#Lock').show();
        $.ajax({
            type: "POST",
            url: url,
            data: sendInfo,
            datatype: "json",
            success: function (data) {
                var m = data;
                windowAppend("body", "/metro/error");
                $("#message").html(m.data);
                $("#fldId").val(m.id);
                switch (m.state) {
                    case 0:
                        $("#error .wintitle").html("ذخیره موفق");
                        break;
                    case 1:
                        $("#error .wintitle").html("خطا");
                        break;
                }
                var url = '@Url.Action("Reload", "Owner")';
                Reload(url, 'Grid', '0', '', 30, 1);
                $('#Lock').hide();

            },
            failure: function (data) {
                alert(data.data);
            }
        });
    }
        </script>
        <div id="dialog" title="فیش">
            <div id="content">
            </div>
        </div>
    </div>
    @*<div id="Grid" style="display: none">
        </div>*@ @*@(Html.Kendo().PanelBar()
        .Name("panelbar3")
        .Items(panelbar =>
        {
            panelbar.Add().Text("ریز محاسبات")
                .Expanded(true)
                .Content(@*@
        <div class="k-rtl demo-section">
           
        </div>@*);*@ @*})
            )*@
        @(Html.Kendo().PanelBar()
        .Name("panelbar1")
        .Items(panelbar =>
        {
            panelbar.Add().Text("سوابق خودرو")
                .Expanded(true)
                .Content(@<div class="k-rtl demo-section">
                    @(Html.Kendo().Grid<Avarez.Models.sp_CarExperienceSelect>()
                .Name("SavabeghGrid")
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldID).Title("کد").Visible(false);
                    columns.Bound(p => p.fldName).Title("شهرداری").Width(100);
                    columns.Bound(p => p.fldLetterNumber).Title("ش نامه").Width(100);
                    columns.Bound(p => p.fldStartDate).Title("از تاریخ").Width(100);
                    columns.Bound(p => p.fldEndDate).Title("تا تاریخ").Width(100);
                    columns.Bound(p => p.fldPlaqueNumber).Title("ش پلاک").Width(170);
                    columns.Bound(p => p.fldUserName).Title("كاربر").Width(170);
                    columns.Bound(p => p.fldDesc).Title("توضیحات").Width(170);
                })
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Pageable()
            .Scrollable()
            .DataSource(data =>
                data.Ajax()
                .PageSize(10)
                            .Read("Savabegh", "inFacture")
                            .Events(h => { h.RequestStart("calcstart"); h.RequestEnd("calcend"); })
            )

                    )
                </div>);
        })
        )
        @(Html.Kendo().PanelBar()
        .Name("panelbar2")
        .Items(panelbar =>
        {
            panelbar.Add().Text("واریزی ها")
                .Expanded(true)
                .Content(@<div class="k-rtl demo-section">
                    @(Html.Kendo().Grid<Avarez.Models.rpt_Receipt>()
                .Name("VarizihaGrid")
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldID).Title("کد").Visible(false);
                    columns.Bound(p => p.fldCollectionDate).Title("تاریخ");
                    columns.Bound(p => p.fldPrice).Title("مبلغ").Format("{0:#,###0}");
                    columns.Bound(p => p.fldMunName).Title("صاحب حساب");
                    columns.Bound(p => p.BankName).Title("بانک عامل");
                    columns.Bound(p => p.UserName).Title("کاربر ثبت کننده");
                    columns.Bound(p => p.sabtkonande).Title("کاربر صادر کننده");
                    columns.Command(c => c.Custom("Resid").Click("Resid").HtmlAttributes(new { @style = "Color:Black;" }).Text("رسید"));
                })
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Pageable()
            .Scrollable()
            .DataSource(data =>
                data.Ajax()
                .PageSize(10)
                            .Read("Variziha", "inFacture").Events(h => { h.RequestStart("calcstart"); h.RequestEnd("calcend"); })
            ).Events(h => h.DataBound("load"))
                    )
                </div>);
        })
        )
    </div>
